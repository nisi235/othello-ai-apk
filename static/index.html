<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>オセロAI対応</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #0b5500;
      font-family: "Meiryo UI", sans-serif;
      margin: 20px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      grid-template-rows: repeat(8, 50px);
      gap: 1px;
      background-color: black;
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 0 10px #004400;
      user-select: none;
    }
    .cell {
      width: 50px;
      height: 50px;
      background-color: #0a7f0a;
      border-radius: 5px;
      cursor: pointer;
      position: relative;
      box-sizing: border-box;
      border: 1px solid #004400;
      transition: background-color 0.2s ease;
    }
    .cell:hover {
      background-color: #0f9f0f;
    }
    .cell.black::after,
    .cell.white::after {
      content: "";
      position: absolute;
      top: 7px;
      left: 7px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .cell.black::after {
      background-color: black;
    }
    .cell.white::after {
      background-color: white;
      border: 1px solid #000;
    }
    #controls {
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #aiSelect {
      font-size: 16px;
      padding: 4px 8px;
    }
    #passButton {
      font-size: 16px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #status {
      margin-top: 10px;
      font-size: 18px;
      color: white;
      height: 24px;
    }
  </style>
</head>
<body>
  <div id="board"></div>

  <div id="controls">
    <label for="aiSelect" style="color:white;">AIレベル選択:</label>
    <select id="aiSelect">
      <option value="ai1">AI レベル 1</option>
      <option value="ai2">AI レベル 2</option>
      <option value="ai3">AI レベル 3</option>
      <option value="ai4">AI レベル 4</option>
      <option value="ai5">AI レベル 5</option>
    </select>
    <button id="passButton">パス</button>
  </div>

  <div id="status"></div>

  <script>
    const BOARD_SIZE = 8;
    let board = Array.from({length: BOARD_SIZE}, () => Array(BOARD_SIZE).fill(0));
    let currentPlayer = 1; // 1=黒(プレイヤー), -1=白(AI)
    const apiUrl = "https://othello-ai-apk.onrender.com/predict"; // 自分のRender URLに書き換える
    const aiSelect = document.getElementById("aiSelect");
    const passButton = document.getElementById("passButton");
    const statusDiv = document.getElementById("status");

    function initializeBoard() {
      for (let y = 0; y < BOARD_SIZE; y++) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          board[y][x] = 0;
        }
      }
      board[3][3] = -1;
      board[3][4] = 1;
      board[4][3] = 1;
      board[4][4] = -1;
    }

    function renderBoard() {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";

      for (let y = 0; y < BOARD_SIZE; y++) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");

          if (board[y][x] === 1) cell.classList.add("black");
          else if (board[y][x] === -1) cell.classList.add("white");

          cell.dataset.x = x;
          cell.dataset.y = y;

          if (currentPlayer === 1 && canPlace(x, y, currentPlayer)) {
            cell.style.cursor = "pointer";
            cell.addEventListener("click", () => {
              if (placePiece(x, y, currentPlayer)) {
                currentPlayer = -1;
                renderBoard();
                statusDiv.textContent = "AIの手を考えています...";
                setTimeout(aiMove, 300);
              }
            });
          } else {
            cell.style.cursor = "default";
          }

          boardDiv.appendChild(cell);
        }
      }
      updateStatus();
    }

    function canPlace(x, y, color) {
      if (board[y][x] !== 0) return false;
      const directions = [
        [1,0], [-1,0], [0,1], [0,-1],
        [1,1], [-1,-1], [1,-1], [-1,1]
      ];
      for (const [dx, dy] of directions) {
        let nx = x + dx;
        let ny = y + dy;
        let foundOpponent = false;
        while (nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE) {
          if (board[ny][nx] === -color) {
            foundOpponent = true;
            nx += dx;
            ny += dy;
          } else {
            break;
          }
        }
        if (foundOpponent && nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE) {
          if (board[ny][nx] === color) return true;
        }
      }
      return false;
    }

    function placePiece(x, y, color) {
      if (!canPlace(x, y, color)) return false;
      board[y][x] = color;
      const directions = [
        [1,0], [-1,0], [0,1], [0,-1],
        [1,1], [-1,-1], [1,-1], [-1,1]
      ];
      for (const [dx, dy] of directions) {
        let nx = x + dx;
        let ny = y + dy;
        let toFlip = [];
        while (nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE && board[ny][nx] === -color) {
          toFlip.push([nx, ny]);
          nx += dx;
          ny += dy;
        }
        if (nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE && board[ny][nx] === color) {
          for (const [fx, fy] of toFlip) {
            board[fy][fx] = color;
          }
        }
      }
      return true;
    }

    function hasValidMoves(color) {
      for (let y = 0; y < BOARD_SIZE; y++) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          if (canPlace(x, y, color)) return true;
        }
      }
      return false;
    }

    function countStones() {
      let black = 0, white = 0;
      for (let y = 0; y < BOARD_SIZE; y++) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          if (board[y][x] === 1) black++;
          else if (board[y][x] === -1) white++;
        }
      }
      return {black, white};
    }

    function updateStatus(message) {
      if(message) {
        statusDiv.textContent = message;
        return;
      }
      const {black, white} = countStones();
      statusDiv.textContent = `黒: ${black}  白: ${white}  現在の手番: ${currentPlayer === 1 ? "あなた" : "AI"}`;
    }

    async function aiMove() {
      if (!hasValidMoves(-1)) {
        if (!hasValidMoves(1)) {
          return endGame();
        }
        alert("AIはパスしました。あなたの手番です。");
        currentPlayer = 1;
        updateStatus();
        renderBoard();
        return;
      }

      // APIに盤面とAIレベルを送る
      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            model_key: aiSelect.value,
            board: board,
          }),
        });
        if (!response.ok) throw new Error("API通信エラー");
        const data = await response.json();
        const {x, y} = data;
        if (placePiece(x, y, -1)) {
          currentPlayer = 1;
          renderBoard();
          if (!hasValidMoves(1)) {
            if (!hasValidMoves(-1)) {
              return endGame();
            }
            alert("あなたはパスしました。AIの手番です。");
            currentPlayer = -1;
            renderBoard();
            setTimeout(aiMove, 500);
          }
        } else {
          alert("AIが無効な手を返しました。");
          currentPlayer = 1;
          updateStatus();
        }
      } catch (e) {
        alert("AIとの通信に失敗しました。");
        currentPlayer = 1;
        updateStatus();
      }
    }

    function endGame() {
      const {black, white} = countStones();
      if(black > white) alert(`ゲーム終了！あなたの勝ち！\n黒: ${black}  白: ${white}`);
      else if(white > black) alert(`ゲーム終了！AIの勝ち！\n黒: ${black}  白: ${white}`);
      else alert(`ゲーム終了！引き分け！\n黒: ${black}  白: ${white}`);
      initializeBoard();
      currentPlayer = 1;
      renderBoard();
      updateStatus();
    }

    passButton.addEventListener("click", () => {
      if (currentPlayer !== 1) {
        alert("あなたの手番ではありません。");
        return;
      }
      if (hasValidMoves(1)) {
        alert("置ける場所があります。パスはできません。");
        return;
      }
      alert("あなたはパスしました。AIの手番です。");
      currentPlayer = -1;
      renderBoard();
      setTimeout(aiMove, 500);
    });

    aiSelect.addEventListener("change", () => {
      // AIレベル変更時は盤面リセット
      initializeBoard();
      currentPlayer = 1;
      renderBoard();
      updateStatus("AIレベルを変更しました。ゲームをリセットしました。");
    });

    initializeBoard();
    renderBoard();
    updateStatus();
  </script>
</body>
</html>
