<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>オセロAI対応</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #0b5500;
      font-family: "Meiryo UI", sans-serif;
      flex-direction: column;
      position: relative;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      grid-template-rows: repeat(8, 50px);
      gap: 1px;
      background-color: black;
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 0 10px #004400;
    }
    .cell {
      width: 50px;
      height: 50px;
      background-color: #0a7f0a;
      border-radius: 5px;
      cursor: pointer;
      position: relative;
      box-sizing: border-box;
      border: 1px solid #004400;
      transition: background-color 0.2s ease;
    }
    .cell:hover {
      background-color: #0f9f0f;
    }
    .cell.black::after,
    .cell.white::after {
      content: "";
      position: absolute;
      top: 7px;
      left: 7px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .cell.black::after {
      background-color: black;
    }
    .cell.white::after {
      background-color: white;
      border: 1px solid #000;
    }
    /* AI選択コンボボックス */
    #aiSelectContainer {
      position: fixed;
      top: 10px;
      right: 10px;
      color: white;
      font-family: "Meiryo UI", sans-serif;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 5px;
      user-select: none;
      z-index: 100;
    }
    #currentAI {
      position: fixed;
      bottom: 10px;
      right: 10px;
      color: white;
      font-family: "Meiryo UI", sans-serif;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 5px;
      user-select: none;
      z-index: 100;
    }
  </style>
</head>
<body>
  <!-- AI選択 -->
  <div id="aiSelectContainer">
    AIレベル:
    <select id="aiSelect">
      <option value="ai1">AIレベル 1</option>
      <option value="ai2">AIレベル 2</option>
      <option value="ai3">AIレベル 3</option>
      <option value="ai4">AIレベル 4</option>
      <option value="ai5">AIレベル 5</option>
    </select>
  </div>

  <!-- 現在のAI表示 -->
  <div id="currentAI">現在のAI: AIレベル 1</div>

  <!-- 盤面 -->
  <div id="board"></div>

  <script>
    const BOARD_SIZE = 8;
    let board = Array.from({length: BOARD_SIZE}, () => Array(BOARD_SIZE).fill(0));
    let currentPlayer = 1; // 1: プレイヤー(黒), -1: AI(白)

    // ここにあなたのFastAPIのpredictエンドポイントURLをセットしてください
    const apiUrl = "https://your-render-app.onrender.com/predict";

    let currentAIKey = "ai1";

    const aiSelect = document.getElementById("aiSelect");
    const currentAIText = document.getElementById("currentAI");

    aiSelect.addEventListener("change", () => {
      currentAIKey = aiSelect.value;
      currentAIText.textContent = `現在のAI: ${aiSelect.options[aiSelect.selectedIndex].text}`;
      resetGame();
    });

    function initializeBoard() {
      for (let y = 0; y < BOARD_SIZE; y++) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          board[y][x] = 0;
        }
      }
      board[3][3] = -1;
      board[3][4] = 1;
      board[4][3] = 1;
      board[4][4] = -1;
    }

    function renderBoard() {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";

      for (let y = 0; y < BOARD_SIZE; y++) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");

          if (board[y][x] === 1) cell.classList.add("black");
          else if (board[y][x] === -1) cell.classList.add("white");

          cell.dataset.x = x;
          cell.dataset.y = y;

          if (currentPlayer === 1) {
            cell.addEventListener("click", () => {
              if (placePiece(x, y, currentPlayer)) {
                currentPlayer = -1; // AIの番
                renderBoard();
                setTimeout(aiMove, 500);
              } else {
                alert("そこには置けません。");
              }
            });
          }

          boardDiv.appendChild(cell);
        }
      }
    }

    function canPlace(x, y, color) {
      if (board[y][x] !== 0) return false;
      const directions = [
        [1,0], [-1,0], [0,1], [0,-1],
        [1,1], [-1,-1], [1,-1], [-1,1]
      ];
      for (const [dx, dy] of directions) {
        let nx = x + dx;
        let ny = y + dy;
        let foundOpponent = false;
        while (nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE) {
          if (board[ny][nx] === -color) {
            foundOpponent = true;
            nx += dx;
            ny += dy;
          } else {
            break;
          }
        }
        if (foundOpponent && nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE) {
          if (board[ny][nx] === color) return true;
        }
      }
      return false;
    }

    function placePiece(x, y, color) {
      if (!canPlace(x, y, color)) return false;
      board[y][x] = color;
      const directions = [
        [1,0], [-1,0], [0,1], [0,-1],
        [1,1], [-1,-1], [1,-1], [-1,1]
      ];
      for (const [dx, dy] of directions) {
        let nx = x + dx;
        let ny = y + dy;
        let toFlip = [];
        while (nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE && board[ny][nx] === -color) {
          toFlip.push([nx, ny]);
          nx += dx;
          ny += dy;
        }
        if (nx >= 0 && ny >= 0 && nx < BOARD_SIZE && ny < BOARD_SIZE && board[ny][nx] === color) {
          for (const [fx, fy] of toFlip) {
            board[fy][fx] = color;
          }
        }
      }
      return true;
    }

    async function aiMove() {
      // 合法手があるか
      let hasValidMove = false;
      for (let y = 0; y < BOARD_SIZE; y++) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          if (canPlace(x, y, currentPlayer)) {
            hasValidMove = true;
            break;
          }
        }
        if (hasValidMove) break;
      }

      if (!hasValidMove) {
        alert("AIはパスしました。");
        currentPlayer = 1;
        renderBoard();
        return;
      }

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            model_key: currentAIKey,
            board: board
          }),
        });

        if (!res.ok) throw new Error(`APIエラー: ${res.status}`);

        const data = await res.json();
        const x = data.x;
        const y = data.y;

        if (placePiece(x, y, currentPlayer)) {
          currentPlayer = 1;
          renderBoard();
        } else {
          alert("AIが不正な手を返しました。");
        }
      } catch (e) {
        alert("AIの手を取得できませんでした。\n" + e.message);
      }
    }

    function resetGame() {
      initializeBoard();
      currentPlayer = 1;
      renderBoard();
    }

    // 初期化
    resetGame();
  </script>
</body>
</html>
