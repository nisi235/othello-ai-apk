<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Othello AI</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
    }
    td {
      width: 40px;
      height: 40px;
      border: 1px solid black;
      background-color: green;
      cursor: pointer;
    }
    .black {
      background-color: black;
      border-radius: 50%;
    }
    .white {
      background-color: white;
      border-radius: 50%;
    }
    #ai-status {
      position: fixed;
      right: 10px;
      bottom: 10px;
      background: #eee;
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>オセロAIと対戦</h1>
  <label for="ai-select">AIレベル選択: </label>
  <select id="ai-select">
    <option value="ai1">ai1</option>
    <option value="ai2">ai2</option>
    <option value="ai3">ai3</option>
    <option value="ai4">ai4</option>
    <option value="ai5">ai5</option>
  </select>
  <button onclick="passTurn()">パス</button>
  <div id="message"></div>
  <table id="board"></table>
  <div id="ai-status">現在のAI: <span id="current-ai">ai1</span></div>

  <script>
    const apiUrl = "https://othello-ai-apk.onrender.com/predict";
    let board = Array(8).fill().map(() => Array(8).fill(0));
    board[3][3] = board[4][4] = -1; // 白
    board[3][4] = board[4][3] = 1;  // 黒
    let currentPlayer = 1; // 1=プレイヤー(黒), -1=AI(白)
    const table = document.getElementById("board");
    const message = document.getElementById("message");
    const aiSelect = document.getElementById("ai-select");
    const currentAiDisplay = document.getElementById("current-ai");

    aiSelect.addEventListener("change", () => {
      currentAiDisplay.textContent = aiSelect.value;
    });

    function drawBoard() {
      table.innerHTML = "";
      for (let y = 0; y < 8; y++) {
        const row = table.insertRow();
        for (let x = 0; x < 8; x++) {
          const cell = row.insertCell();
          if (board[y][x] === 1) cell.className = "black";
          else if (board[y][x] === -1) cell.className = "white";
          else cell.onclick = () => playerMove(x, y);
        }
      }
    }

    function passTurn() {
      if (currentPlayer === 1) {
        currentPlayer = -1;
        aiMove();
      }
    }

    async function playerMove(x, y) {
      if (board[y][x] !== 0 || currentPlayer !== 1) return;
      if (!isValidMove(x, y, currentPlayer)) return;

      applyMove(x, y, currentPlayer);
      currentPlayer = -1;
      drawBoard();
      if (hasValidMoves(-1)) await aiMove();
      else if (!hasValidMoves(1)) showResult();
    }

    async function aiMove() {
      const response = await fetch(apiUrl, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          model_key: aiSelect.value,
          board: board
        })
      });
      const data = await response.json();
      const {x, y} = data;

      if (board[y][x] === 0 && isValidMove(x, y, -1)) {
        applyMove(x, y, -1);
      }
      currentPlayer = 1;
      drawBoard();

      if (!hasValidMoves(1) && !hasValidMoves(-1)) showResult();
    }

    function isValidMove(x, y, player) {
      if (board[y][x] !== 0) return false;
      const directions = [-1, 0, 1];
      for (let dx of directions) {
        for (let dy of directions) {
          if (dx === 0 && dy === 0) continue;
          let nx = x + dx, ny = y + dy;
          let hasOpponent = false;
          while (nx >= 0 && ny >= 0 && nx < 8 && ny < 8) {
            if (board[ny][nx] === -player) {
              hasOpponent = true;
            } else if (board[ny][nx] === player && hasOpponent) {
              return true;
            } else break;
            nx += dx; ny += dy;
          }
        }
      }
      return false;
    }

    function applyMove(x, y, player) {
      board[y][x] = player;
      const directions = [-1, 0, 1];
      for (let dx of directions) {
        for (let dy of directions) {
          if (dx === 0 && dy === 0) continue;
          let nx = x + dx, ny = y + dy;
          let toFlip = [];
          while (nx >= 0 && ny >= 0 && nx < 8 && ny < 8) {
            if (board[ny][nx] === -player) {
              toFlip.push([nx, ny]);
            } else if (board[ny][nx] === player) {
              for (let [fx, fy] of toFlip) board[fy][fx] = player;
              break;
            } else break;
            nx += dx; ny += dy;
          }
        }
      }
    }

    function hasValidMoves(player) {
      for (let y = 0; y < 8; y++) {
        for (let x = 0; x < 8; x++) {
          if (isValidMove(x, y, player)) return true;
        }
      }
      return false;
    }

    function showResult() {
      const flat = board.flat();
      const black = flat.filter(v => v === 1).length;
      const white = flat.filter(v => v === -1).length;
      if (black > white) message.textContent = "あなたの勝ち！";
      else if (white > black) message.textContent = "AIの勝ち！";
      else message.textContent = "引き分け！";
    }

    drawBoard();
  </script>
</body>
</html>
